<?xml version="1.0"?>
<rss version="2.0">
  <channel>
    <title>Leftleg&#39;s blog</title>
    <link>http://leftleg.hzpub.com</link>
    <pubDate>2013-04-11 05:34:31 +0800</pubDate>
    <item>
      <title>Cloudfoundry on Openstack 使用 BOSH 完整部署</title>
      <link>http://leftleg.hzpub.com/cloudfoundry/Cloudfoundry-on-Openstack-%E4%BD%BF%E7%94%A8-BOSH-%E5%AE%8C%E6%95%B4%E9%83%A8%E7%BD%B2/</link>
      <pubDate>2013-04-11 12:00:00 +0800</pubDate>
      <description>&lt;h3&gt;了解&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://cndocs.cloudfoundry.com/deploy/bosh-docs.html&#34;&gt;什么是bosh&lt;/a&gt;&lt;/p&gt;

&lt;h3&gt;系统需求&lt;/h3&gt;

&lt;p&gt;仅支持 Ubuntu 10.04 LTS 64-bit image (目前也有人用 centos6 实现)&lt;/p&gt;

&lt;h3&gt;部署过程&lt;/h3&gt;

&lt;p&gt;Inception VM &amp;ndash;&amp;gt; micro-bosh &amp;ndash;&amp;gt; bosh &amp;ndash;&amp;gt; cloudfoundry&lt;/p&gt;

&lt;p&gt;###准备&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Inception VM   1vm&lt;/li&gt;
&lt;li&gt;micro-bosh     1vm&lt;/li&gt;
&lt;li&gt;bosh           8vm&lt;/li&gt;
&lt;li&gt;cloudfoundry   13+ vm&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;请确认 openstack 各项服务正常 特别是 meta-data 服务&lt;/strong&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h3&gt;1. 安装 Inception VM 部署 micro-bosh&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;用途&lt;/strong&gt; (转)&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;create a custom micro BOSH stemcell&lt;/li&gt;
&lt;li&gt;create an OpenStack image from the custom micro BOSH stemcell&lt;/li&gt;
&lt;li&gt;run a registry of OpenStack to track provisioned components in OpenStack&lt;/li&gt;
&lt;li&gt;store a registry of deployed Micro BOSHes&lt;/li&gt;
&lt;li&gt;store log files of BOSH CLI interactions with each Micro BOSH&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;###&lt;strong&gt;安装&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;使用 &amp;ldquo;Ubuntu 10.04 LTS 64-bit image&amp;rdquo; 镜像在Openstack上创建一个vm,取名 Inception VM (此vm需要能上网,可能还需要能翻墙)
(也可以使用 fog &lt;a href=&#34;http://fog.io/&#34;&gt;http://fog.io/&lt;/a&gt; 创建一个vm)&lt;/p&gt;

&lt;h4&gt;&lt;em&gt;登录到 Inception VM&lt;/em&gt;&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;export ORIGUSER=ubuntu
export UBUNTU_ISO=/root/ubuntu-10.04.4-LTS-amd64.iso
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上传iso到 /root 目录,此步不是必做,但能提高效率,不然需要的包都从网络取&lt;/p&gt;

&lt;h4&gt;&lt;em&gt;执行初始化环境脚本&lt;/em&gt;&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;curl -s https://github.com/leftleghu/cloudfoundry/blob/master/prepare_inception_openstack.sh | bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;此脚本包含了bosh命令所需环境,具体自己看脚本吧&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;source /etc/profile
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;脚本最后的 bosh help micro , 应该会输出 bosh micro 的帮助信息,不过没输出的话,说明bug还没修补,我们可以执行:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd /var/vcap/bootstrap/bosh/deployer
gem install pkg/bosh_deployer-1.3.1.gem
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;然后执行  bosh help micro ，看看是否正常输出.&lt;/p&gt;

&lt;h4&gt;&lt;em&gt;配置&lt;/em&gt;&lt;/h4&gt;

&lt;p&gt;现在可以开始准备部署 micro-bosh,配置文件是 micro_bosh.yml&lt;/p&gt;

&lt;p&gt;关于 Manifest 的语法可以看这里: &lt;a href=&#34;https://github.com/panlm/doc/blob/master/documentation.md&#34;&gt;https://github.com/panlm/doc/blob/master/documentation.md&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd /var/vcap/deployments
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;转到deployments目录，此目录由之前 prepare_inception_openstack.sh 创建&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -s https://github.com/leftleghu/cloudfoundry/blob/master/create_keypair &amp;gt; /tmp/create_keypair
chmod 755 /tmp/create_keypair
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;使用脚本创建一个 inception keypair，以后方便登录使用&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/tmp/create_keypair openstack OS_USERNAME OS_PASSWORD OS_TENANT_NAME OS_AUTH_URL inception
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;使用脚本生成 micro_bosh.yml&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -s https://github.com/leftleghu/cloudfoundry/blob/master/create_micro_bosh_yml &amp;gt; /tmp/create_micro_bosh_yml
chmod 755 /tmp/create_micro_bosh_yml
/tmp/create_micro_bosh_yml microbosh-openstack openstack OS_USERNAME OS_PASSWORD OS_TENANT_NAME OS_AUTH_URL inception IP_ADDRESS PASSWORD
&lt;/code&gt;&lt;/pre&gt;

&lt;h4&gt;&lt;em&gt;自定义 stemcell&lt;/em&gt;&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;cd /var/vcap/releases/bosh-release  
bosh create release --with-tarball
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;创建 release，结果会输出:/var/vcap/releases/bosh-release/dev_releases/bosh-x.y-dev.tgz&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd /var/vcap/bootstrap/bosh/agent
rake stemcell2:micro[&amp;quot;openstack&amp;quot;,/var/vcap/releases/bosh-release/micro/openstack.yml,/var/vcap/releases/bosh-release/dev_releases/bosh-x.y-dev.tgz]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;创建 stemcell 这样就得到了自定义的stemcell。一切正常的话会输出:&lt;br /&gt;
Generated stemcell: /var/tmp/bosh/agent-x.y.z-nnnnn/work/work/micro-bosh-stemcell-openstack-x.y.z.tgz&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd /var/vcap/stemcells
cp /var/tmp/bosh/agent-x.y.z-nnnnn/work/work/micro-bosh-stemcell-openstack-x.y.z.tgz .
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;拷贝 stemcell 到部署目录&lt;/p&gt;

&lt;h4&gt;&lt;em&gt;部署 micro-bosh&lt;/em&gt;&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;cd /var/vcap/deployments
bosh micro deployment microbosh-openstack
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;一切正常的话部署完毕.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;bosh target http://1.2.3.4
Target set to `microbosh-openstack (http://1.2.3.4:25555) Ver: 0.6 (release:ce0274ec bosh:0d9ac4d4)&#39;
Your username: admin
Enter password: *****
Logged in as `admin&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;可以 target 到 micro-bosh ，默认验证: admin:admin&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;bosh status
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;查看部署状态&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;bosh micro status
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;查看micro-bosh状态&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd /var/vcap/deployments
tail -f microbosh-openstack/bosh_micro_deploy.log
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;排错检查日志&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;bosh micro delete
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;如果遇到问题，需要重建，最好通过此命令删除 micro-bosh,不要手工删除虚拟机&lt;/p&gt;
</description>
    </item>
    <item>
      <title>A new beginning</title>
      <link>http://leftleg.hzpub.com/default/A-new-beginning/</link>
      <pubDate>2013-04-11 12:00:00 +0800</pubDate>
      <description>&lt;p&gt;Blog 一个新的开始,以前的Blog还在openshift,换了域名leftleghu.hzpub.com
不能访问?要翻墙唉！&lt;/p&gt;

&lt;h2&gt;&lt;img src=&#34;http://pic.yupoo.com/leftleg/C5b6Xltz/medium.jpg&#34; alt=&#34;新的开始&#34; /&gt;
&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;现在寄居在 Github,相对于以前的地方有如下好处：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;免费,完全免费&lt;/li&gt;
&lt;li&gt;稳定,相对于之前的 cloudfoundry appfog openshift,一圈用下来,应该会更稳定.&lt;/li&gt;
&lt;li&gt;速度快,虽然都在国外,但 cloudfoundry appfog openshift 因为某些原因都是龟速.当然静态的轻量级也是其中一个原因.&lt;/li&gt;
&lt;li&gt;至上次刷票事件以后,Github 的经历,至少目前来说被xx的可能不大.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;需要注意的地方:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;因为是静态的缘故,写博客就没有以前那么方便了,还需要操作 Github,如果你也想放在Github的话.&lt;/li&gt;
&lt;li&gt;其他的,或者具体的,提供几个关键字: &lt;a href=&#34;https://github.com/wendal/gor&#34; title=&#34;gor&#34;&gt;gor&lt;/a&gt; &lt;a href=&#34;http://ruhoh.com/&#34; title=&#34;ruhoh&#34;&gt;ruhoh&lt;/a&gt; &lt;a href=&#34;http://wowubuntu.com/markdown/&#34; title=&#34;markdown&#34;&gt;markdown&lt;/a&gt; &lt;a href=&#34;http://markdownpad.com&#34; title=&#34;markdownpad&#34;&gt;markdownpad&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
  </channel>
</rss>